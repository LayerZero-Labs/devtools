#   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-
#  / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \
# `-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'
#
#           Docker compose for running E2E tests
#
#   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-
#  / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \
# `-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'
version: "3.9"

services:
  # ~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~
  #
  #        Network nodes, one for every hardhat network
  #
  # .oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.
  network-vengaboys:
    extends:
      file: docker-compose.templates.yaml
      service: evm-node

  network-britney:
    extends:
      file: docker-compose.templates.yaml
      service: evm-node

  # ~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~^~
  #
  #                       The actual tests
  #
  # .oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.
  tests:
    extends:
      file: docker-compose.templates.yaml
      service: project
    depends_on:
      network-vengaboys:
        condition: service_healthy
      network-britney:
        condition: service_healthy
    logging:
      driver: none
    # The default containerized setup will specify the network URLs
    # for the internal networks
    #
    # This works in conjunction with hardhat configs in the test projects.
    #
    # If these environment variables are not specified, the exposed networks are used
    # that need to be started using docker compose up:
    #
    # docker compose -f docker-compose.yaml -f docker-compose.local.yaml up network-britney network-vengaboys
    environment:
      - NETWORK_URL_BRITNEY=http://network-britney:8545
      - NETWORK_URL_VENGABOYS=http://network-vengaboys:8545
    volumes:
      - ./node_modules/.cache/turbo:/app/node_modules/.cache/turbo
      - ./packages:/app/packages
      - ./tests:/app/tests
      # Hardhat has an issue with caching compilers inside a docker container,
      # failing with EACCES -13 error, pointing to a permissions issue with the cache folder.
      #
      # The workaround is to provide an outside volume to work
      # as a cache directory for hardhat so that the permissions
      # don't clash
      - ./.cache/hardhat:/root/.cache/hardhat-nodejs
    command: "npx turbo test $DOCKER_COMPOSE_RUN_TESTS_TURBO_ARGS"

#   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-  .-.-.   .-.-.   .-.-
#  / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ / / \ \ / / \ \ / / \
# `-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-'   `-`-'   `-`-'
#
#        Reusable workflow that runs the whole test suite, linter and build
#
#   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-  .-.-.   .-.-.   .-.-
#  / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ \ / / \ / / \ \ / / \ \ / / \
# `-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-'   `-`-'   `-`-'
name: Vape Tests

on:
  workflow_call:

# We'll default the NPM_TOKEN to an empty value since we use it
# in .npmrc file and if undefined, the node setup would fail
env:
  NPM_TOKEN: ""

jobs:
  debug-publish:
    name: Debug Publish
    runs-on: ubuntu-latest

    # We'll run the job on the prebuilt base image
    container:
      image: ghcr.io/layerzero-labs/devtools-dev-base:main
      options: --user root

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: "true"
          token: ${{ secrets.LAYERZERO_BOT_GITHUB_TOKEN }}

      - name: Setup environment
        uses: ./.github/workflows/actions/setup-environment

      # - name: Install dependencies
      #   uses: ./.github/workflows/actions/install-dependencies

      # - name: Setup build cache
      #   uses: ./.github/workflows/actions/setup-build-cache

      - name: Fix ownership
        run: ls -al

      # - name: Fix ownership
      #   run: chown -R root .

      # This step uses the changesets CLI to bump the package versions and/or publish the unpublished packages
      #
      # How this works is:
      #
      # - If there are any changesets (markdown files in the .changeset directory),
      #   changesets CLI will bump the package versions according to the bumps specified in the markdown files.
      #
      # - A PR is created containing these version bumps and with the changeset markdowns deleted
      #
      # - Once this PR is merged, this workflow kicks in again and this time checks
      #   whether there is anything that needs to be published
      - name: Publish packages / create version bump PRs
        uses: changesets/action@v1
        with:
          cwd: /__w/devtools/devtools
          setupGitUser: false
          version: pnpm release:version
          publish: pnpm release:publish
          title: "ðŸš€ Version packages"

        env:
          # This is here because changesets/action will look for the .npmrc
          # in HOME folder and if it doesn't find one there it will create one
          #
          # Since we want to make sure it uses our .npmrc we'll just point it
          # to our workspace root (which, in a workflow that uses a container, is put under __w directory)
          #
          # Here we need to use the ${GITHUB_WORKSPACE} environment variable instead
          # of the context value ${{ github.workspace }}
          #
          # See more here https://github.com/actions/runner/issues/2058
          HOME: ${{ github.workspace }}
          GITHUB_TOKEN: INVALID
